<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Chat</title>
</head>
<body>
    <h1 id="head1">SignalR Chat</h1>
    <div>
        <input type="text" id="displayname" placeholder="Enter User Name" />
        <input type="button" id="connect" value="Connect" />
        <input type="button" id="disconnect" value="Disconnect" />

        <input type="checkbox" id="autoReconnect" />
        Enable normal reconnects
        <input type="checkbox" id="statefulReconnect" checked />
        Enable stateful reconnects
    </div>

    <h4>Send To Everybody</h4>
    <form class="form-inline">
        <div class="input-append">
            <input type="text" id="message-text" placeholder="Type a message" />
            <input type="button" id="broadcast" class="btn" value="Broadcast" />
        </div>
    </form>

    <ul id="message-list"></ul>

    <script src="js/dist/browser/signalr.js"></script>
    <script>
        function addLine(listId, line, color) {
            var child = document.createElement('li');
            if (color) {
                child.style.color = color;
            }
            child.innerText = line;
            document.getElementById(listId).appendChild(child);
        }

        let connectButton = document.getElementById('connect');
        let disconnectButton = document.getElementById('disconnect');
        let autoReconnectCheckbox = document.getElementById('autoReconnect');
        let statefulReconnectCheckbox = document.getElementById('statefulReconnect');
        let broadcastButton = document.getElementById('broadcast');
        let messageInput = document.getElementById('message-text');

        function updateButtonState(isConnected) {
            connectButton.disabled = isConnected;
            disconnectButton.disabled = !isConnected;
            broadcastButton.disabled = !isConnected;
        }

        updateButtonState(false);
        var name;
        var connection;

        connectButton.addEventListener('click', function (event) {
            name = document.getElementById("displayname").value
            if (name === "") {
                alert("Please enter a valid name");
                return;
            }

            hubRoute = `chat?name=${name}`;
            console.log(`http://${document.location.host}/chat`);

            var connectionBuilder = new signalR.HubConnectionBuilder()
                .configureLogging("trace")
                .withUrl(hubRoute);

            if (autoReconnectCheckbox.checked) {
                connectionBuilder.withAutomaticReconnect();
            }

            if (statefulReconnectCheckbox.checked) {
                connectionBuilder.withStatefulReconnect();
            }

            connection = connectionBuilder.build();

            connection.on('Send', function (msg) {
                addLine('message-list', msg);
            });

            connection.onclose(function (e) {
                if (e) {
                    addLine('message-list', 'Connection closed with error: ' + e, 'red');
                }
                else {
                    addLine('message-list', 'Disconnected', 'green');
                }
                updateButtonState(false);
            });

            connection.onreconnecting(function (e) {
                addLine('message-list', 'Connection reconnecting: ' + e, 'orange');
            });

            connection.onreconnected(function (e) {
                addLine('message-list', 'Connection reconnected!', 'green');
            });

            connection.start()
                .then(function () {
                    isConnected = true;
                    updateButtonState(true);
                    addLine('message-list', 'Connected successfully', 'green');
                })
                .catch(function (err) {
                    updateButtonState(false);
                    addLine('message-list', err, 'red');
                });
        });

        broadcastButton.addEventListener('click', function (event) {
            connection.invoke('SendAll', name, messageInput.value)
        });

        disconnectButton.addEventListener('click', function (event) {
            connection.stop()
                .then(function () {
                    isConnected = false;
                    updateButtonState(false);
                });
        });
    </script>
</body>
</html>